# Development Automations and Smart Shortcuts
# Advanced functions for TypeScript developers

# Load project templates
if [ -f ~/.project-templates ]; then
    source ~/.project-templates
fi

# Smart project initialization with modern tools and expanded templates
function init-project() {
    local project_type="${1:-typescript}"
    local project_name="$2"

    if [ -z "$project_name" ]; then
        echo "Usage: init-project [type] <name>"
        echo "Types:"
        echo "  Frontend: react, vue, svelte, nextjs, nuxt, angular"
        echo "  Backend:  express, fastify, nest, deno, bun-server"
        echo "  Fullstack: t3-stack, remix"
        echo "  Mobile: react-native, expo"
        echo "  Desktop: electron, tauri"
        echo "  Library: typescript, javascript, node-package"
        echo "  Other: astro, vite, playwright, storybook"
        return 1
    fi

    # Detect and validate package manager
    local pm="npm"
    if command -v bun &> /dev/null; then
        pm="bun"
    elif command -v pnpm &> /dev/null; then
        pm="pnpm"
    elif command -v yarn &> /dev/null; then
        pm="yarn"
    fi

    echo "üöÄ Creating $project_type project '$project_name' with $pm..."
    mkdir "$project_name"
    cd "$project_name"

    case "$project_type" in
        # Backend frameworks
        "typescript"|"ts")
            create-ts-project-enhanced "$project_name"
            ;;
        "express")
            create-express-ts-project "$project_name"
            ;;
        "fastify")
            create-fastify-ts-project "$project_name"
            ;;
        "nest"|"nestjs")
            create-nest-project "$project_name"
            ;;
        "deno")
            create-deno-project "$project_name"
            ;;
        "bun-server")
            create-bun-server-project "$project_name"
            ;;

        # Frontend frameworks
        "react")
            create-react-project "$project_name"
            ;;
        "vue")
            create-vue-project "$project_name"
            ;;
        "svelte")
            create-svelte-project "$project_name"
            ;;
        "angular")
            create-angular-project "$project_name"
            ;;
        "nextjs"|"next")
            create-nextjs-project "$project_name"
            ;;
        "nuxt")
            create-nuxt-project "$project_name"
            ;;
        "astro")
            create-astro-project "$project_name"
            ;;

        # Fullstack frameworks
        "t3-stack"|"t3")
            create-t3-project "$project_name"
            ;;
        "remix")
            create-remix-project "$project_name"
            ;;

        # Mobile & Desktop
        "react-native"|"rn")
            create-react-native-project "$project_name"
            ;;
        "expo")
            create-expo-project "$project_name"
            ;;
        "electron")
            create-electron-project "$project_name"
            ;;
        "tauri")
            create-tauri-project "$project_name"
            ;;

        # Development tools
        "vite")
            create-vite-project "$project_name"
            ;;
        "playwright")
            create-playwright-project "$project_name"
            ;;
        "storybook")
            create-storybook-project "$project_name"
            ;;
        "node-package"|"package")
            create-node-package "$project_name"
            ;;

        *)
            echo "‚ùå Unknown project type: $project_type"
            echo "Run 'init-project' without arguments to see available types."
            cd .. && rmdir "$project_name"
            return 1
            ;;
    esac

    # Common post-setup tasks
    post_project_setup "$project_name" "$project_type"
}

# Common post-project setup tasks
post_project_setup() {
    local project_name="$1"
    local project_type="$2"

    # Create common config files if they don't exist
    if [[ ! -f ".env.example" ]]; then
        cat > .env.example << 'EOF'
# Environment variables template
NODE_ENV=development
PORT=3000
EOF
    fi

    if [[ ! -f ".gitignore" ]]; then
        cat > .gitignore << 'EOF'
# Dependencies
node_modules/
.pnpm-debug.log*
.yarn-integrity

# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Coverage directory used by tools like istanbul
coverage/
*.nyc_output

# Compiled binary addons (https://nodejs.org/api/addons.html)
build/Release/

# Dependency directories
node_modules/
jspm_packages/

# Snowpack dependency directory (https://snowpack.dev/)
web_modules/

# TypeScript cache
*.tsbuildinfo

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Optional stylelint cache
.stylelintcache

# Microbundle cache
.rpt2_cache/
.rts2_cache_cjs/
.rts2_cache_es/
.rts2_cache_umd/

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# Yarn Integrity file
.yarn-integrity

# dotenv environment variables file
.env
.env.development.local
.env.test.local
.env.production.local
.env.local

# parcel-bundler cache (https://parceljs.org/)
.cache
.parcel-cache

# Next.js build output
.next
.nuxt
out/

# Gatsby files
.cache/
public

# Vuepress build output
.vuepress/dist

# Serverless directories
.serverless/

# FuseBox cache
.fusebox/

# DynamoDB Local files
.dynamodb/

# TernJS port file
.tern-port

# Stores VSCode versions used for testing VSCode extensions
.vscode-test

# yarn v2
.yarn/cache
.yarn/unplugged
.yarn/build-state.yml
.yarn/install-state.gz
.pnp.*

# IDE
.vscode/
.idea/

# OS
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Build outputs
dist/
build/
*.tgz
EOF
    fi

    # Initialize git if not already done
    if [[ ! -d ".git" ]]; then
        git init
        echo "üîß Initialized Git repository"

        # Add all files and make initial commit
        git add .
        git commit -m "Initial commit: $project_type project setup"
        echo "üìù Created initial commit"
    fi

    echo ""
    echo "üéâ Successfully created $project_type project '$project_name'!"
    echo "üìÅ Project location: $(pwd)"
    echo ""

    # Show next steps based on project type
    case "$project_type" in
        "react"|"vue"|"svelte"|"angular"|"nextjs"|"nuxt"|"astro")
            echo "üöÄ Start development server: npm run dev (or yarn dev / pnpm dev / bun dev)"
            ;;
        "express"|"fastify"|"nest"|"bun-server")
            echo "üöÄ Start API server: npm run dev (or yarn dev / pnpm dev / bun dev)"
            ;;
        "deno")
            echo "üöÄ Start Deno server: deno task dev"
            ;;
        "electron")
            echo "üöÄ Build and start: npm run build && npm start"
            ;;
        "tauri")
            echo "üöÄ Start Tauri app: cargo tauri dev"
            ;;
        "playwright")
            echo "üß™ Run tests: npm test (or yarn test / pnpm test / bun test)"
            ;;
        *)
            echo "üí° Check package.json for available scripts"
            ;;
    esac
}

# Enhanced TypeScript project with modern tooling
function create-ts-project-enhanced() {
    local name="$1"

    # Package manager detection
    local pm="npm"
    if command -v bun &> /dev/null; then
        pm="bun"
    elif command -v pnpm &> /dev/null; then
        pm="pnpm"
    fi

    echo "üöÄ Creating TypeScript project with $pm..."

    # Initialize package.json
    $pm init -y

    # Install dependencies
    if [ "$pm" = "bun" ]; then
        bun add -d typescript @types/node ts-node nodemon prettier eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin
    else
        $pm install -D typescript @types/node ts-node nodemon prettier eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin
    fi

    # Create project structure
    mkdir -p src tests docs

    # Create main file
    cat > src/index.ts << 'EOF'
console.log('Hello, TypeScript! üöÄ');

export function greet(name: string): string {
    return `Hello, ${name}!`;
}
EOF

    # Create test file
    cat > tests/index.test.ts << 'EOF'
import { greet } from '../src/index';

describe('greet function', () => {
    test('should return greeting', () => {
        expect(greet('World')).toBe('Hello, World!');
    });
});
EOF

    # Enhanced tsconfig.json
    cat > tsconfig.json << 'EOF'
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "CommonJS",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "removeComments": true,
    "noImplicitReturns": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
EOF

    # Package.json scripts
    npm pkg set scripts.dev="ts-node src/index.ts"
    npm pkg set scripts.build="tsc"
    npm pkg set scripts.start="node dist/index.js"
    npm pkg set scripts.test="jest"
    npm pkg set scripts.lint="eslint src/**/*.ts"
    npm pkg set scripts.format="prettier --write src/**/*.ts"
    npm pkg set scripts.clean="rm -rf dist"

    # Create .env template
    cat > .env.example << 'EOF'
# Environment variables template
NODE_ENV=development
PORT=3000
EOF

    echo "üìÅ Project structure created with modern TypeScript setup"
}

# Express TypeScript project
function create-express-ts-project() {
    local name="$1"

    # Basic setup
    npm init -y
    npm install express cors helmet morgan
    npm install -D typescript @types/node @types/express @types/cors @types/helmet @types/morgan ts-node nodemon

    mkdir -p src/{routes,middleware,types}

    # Express app
    cat > src/app.ts << 'EOF'
import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import morgan from 'morgan';

const app = express();
const PORT = process.env.PORT || 3000;

app.use(helmet());
app.use(cors());
app.use(morgan('combined'));
app.use(express.json());

app.get('/', (req, res) => {
    res.json({ message: 'TypeScript Express API üöÄ' });
});

app.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
});
EOF

    npm pkg set scripts.dev="nodemon --exec ts-node src/app.ts"
    npm pkg set scripts.build="tsc"
    npm pkg set scripts.start="node dist/app.js"

    echo "üåê Express TypeScript API created"
}

# Smart package installer with version management
function smart-install() {
    local package="$1"
    local dev_flag="$2"

    if [ -z "$package" ]; then
        echo "Usage: smart-install <package> [--dev]"
        return 1
    fi

    # Detect package manager
    if [ -f "bun.lockb" ] && command -v bun &> /dev/null; then
        if [ "$dev_flag" = "--dev" ]; then
            bun add -d "$package"
        else
            bun add "$package"
        fi
    elif [ -f "pnpm-lock.yaml" ] && command -v pnpm &> /dev/null; then
        if [ "$dev_flag" = "--dev" ]; then
            pnpm add -D "$package"
        else
            pnpm add "$package"
        fi
    else
        if [ "$dev_flag" = "--dev" ]; then
            npm install -D "$package"
        else
            npm install "$package"
        fi
    fi
}

# Project health check
function project-health() {
    echo "üîç Checking project health..."

    # Check package.json
    if [ ! -f "package.json" ]; then
        echo "‚ùå No package.json found"
        return 1
    fi

    # Check for outdated dependencies
    echo "üì¶ Checking dependencies..."
    if command -v npm &> /dev/null; then
        npm outdated
    fi

    # Check for security vulnerabilities
    echo "üîí Security audit..."
    npm audit --audit-level moderate

    # Check TypeScript compilation
    if [ -f "tsconfig.json" ]; then
        echo "üîß TypeScript check..."
        npx tsc --noEmit
    fi

    # Check for common issues
    echo "üßπ Checking for common issues..."
    if [ -d "node_modules" ] && [ ! -f ".gitignore" ]; then
        echo "‚ö†Ô∏è  No .gitignore found - node_modules might be committed"
    fi

    if [ ! -f "README.md" ]; then
        echo "üìù No README.md found"
    fi

    echo "‚úÖ Health check complete"
}

# Quick commit with conventional commit format
function quick-commit() {
    local type="$1"
    local message="$2"
    local scope="$3"

    if [ -z "$type" ] || [ -z "$message" ]; then
        echo "Usage: quick-commit <type> <message> [scope]"
        echo "Types: feat, fix, docs, style, refactor, test, chore"
        return 1
    fi

    local commit_msg
    if [ -n "$scope" ]; then
        commit_msg="$type($scope): $message"
    else
        commit_msg="$type: $message"
    fi

    git add .
    git commit -m "$commit_msg"
    echo "‚úÖ Committed: $commit_msg"
}

# Environment switcher for different Node versions
function switch-node() {
    if [ -f ".nvmrc" ]; then
        echo "üìç Using Node version from .nvmrc"
        nvm use
    else
        echo "üîÑ Switching to Node LTS"
        nvm use --lts
    fi

    echo "üì¶ Current versions:"
    node --version
    npm --version
    if command -v bun &> /dev/null; then
        bun --version
    fi
}

# Benchmark command execution
function bench-cmd() {
    local cmd="$1"
    if [ -z "$cmd" ]; then
        echo "Usage: bench-cmd <command>"
        return 1
    fi

    if command -v hyperfine &> /dev/null; then
        hyperfine --warmup 3 "$cmd"
    else
        echo "Hyperfine not installed. Using basic time..."
        time eval "$cmd"
    fi
}
