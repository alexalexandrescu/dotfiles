name: Test Dotfiles

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Test weekly to catch external dependency issues
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual triggering

jobs:
  test-configuration:
    name: Test Configuration and Syntax
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            package_manager: apt
          - os: macos-latest
            package_manager: brew

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python for YAML parsing
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install Python dependencies
      run: pip install PyYAML

    - name: Install system dependencies
      shell: bash
      run: |
        if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
          sudo apt-get update
          sudo apt-get install -y jq curl wget git zsh
        elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
          # Install Homebrew if not present
          if ! command -v brew &>/dev/null; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          brew install jq
        fi

    - name: Install dotfiles
      shell: bash
      env:
        CI: true
      run: |
        # Install dotfiles using dotbot
        ./install

    - name: Run configuration tests
      shell: bash
      env:
        CI: true
        CONTAINER: true
      run: |
        # Set up minimal git config for tests
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # Run the enhanced test suite
        ./test/test-dotfiles.sh

    - name: Test package installer
      shell: bash
      run: |
        # Test the new YAML-based package installer
        ./scripts/install-packages-yaml.sh --dry-run development
        ./scripts/install-packages-yaml.sh --help

  test-installation-docker:
    name: Test Installation via Docker
    runs-on: ubuntu-latest
    if: false # Temporarily disabled - Docker tests need to be fixed
    strategy:
      matrix:
        scenario: [fresh, safe] # Remove macos from Docker tests

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build Docker Image (if not already built)
      run: ./test-docker.sh build

    - name: Run Docker Test Scenario - ${{ matrix.scenario }}
      run: ./test-docker.sh ${{ matrix.scenario }}

    - name: Clean up Docker containers
      if: always()
      run: ./test-docker.sh clean

  pre-commit:
    name: Pre-commit Checks
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install pre-commit
      run: pip install pre-commit

    - name: Run pre-commit hooks
      run: pre-commit run --all-files